<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin - POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#333;padding:20px}
    .admin{max-width:800px;margin:0 auto}
    h1{color:#667eea;margin-bottom:20px}
    section{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h3{color:#333;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #667eea}
    .form-group{margin-bottom:15px}
    label{display:block;margin-bottom:5px;color:#666}
    input,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:1rem}
    button{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:10px;margin-top:10px}
    #ordersList{list-style:none}
    #ordersList li{padding:15px;border-bottom:1px solid #eee}
    .test-print-btn{background:#4caf50!important}
    .empty{text-align:center;color:#999;padding:20px}
    .order-header{display:flex;justify-content:space-between;margin-bottom:10px}
    .order-time{color:#666;font-size:0.85rem}
    .order-items{margin:10px 0;padding:10px;background:#f8f8f8;border-radius:6px}
    .order-total{font-weight:bold;color:#667eea;margin:10px 0}
    .mark-paid-btn{background:#ff9800!important}
  </style>
</head>
<body>
  <div class="admin">
    <h1>Admin</h1>
    <section>
      <h3>CSV Management</h3>
      <select id="csvSelect" style="margin-bottom:10px">
        <option value="menu.csv">menu.csv</option>
        <option value="sets.csv">sets.csv</option>
        <option value="attributes.csv">attributes.csv</option>
      </select>
      <input type="file" id="csvFile" accept=".csv" style="margin-bottom:10px" />
      <div>
        <button id="validateCsv">Validate</button>
        <button id="uploadCsv">Upload</button>
        <button id="downloadCsv">Download</button>
      </div>
      <pre id="csvPreview" style="max-height:200px;overflow:auto;border:1px solid #eee;padding:8px;margin-top:10px"></pre>
    </section>
    <section>
      <h3>Printer Setup Guide</h3>
      <div style="background:#f8f8f8;padding:15px;border-radius:8px;margin-bottom:15px">
        <p style="margin-bottom:10px"><strong>⚡ Quick Info: Which Mode Works Where?</strong></p>
        <table style="width:100%;font-size:0.85rem;margin-bottom:15px;">
          <tr style="background:#e3f2fd;">
            <th style="padding:8px;text-align:left">Deployment</th>
            <th style="padding:8px;text-align:left">Port Type</th>
            <th style="padding:8px;text-align:left">Status</th>
          </tr>
          <tr>
            <td style="padding:8px;border-bottom:1px solid #ddd">Local <code>node server.js</code></td>
            <td style="padding:8px;border-bottom:1px solid #ddd">TCP (9100) ✅ &amp; EPOS (8043) ✅</td>
            <td style="padding:8px;border-bottom:1px solid #ddd">Both work</td>
          </tr>
          <tr style="background:#fff3e0;">
            <td style="padding:8px;border-bottom:1px solid #ddd">Cloudflare Pages + Worker</td>
            <td style="padding:8px;border-bottom:1px solid #ddd">TCP (9100) ❌ / EPOS (8043) ✅</td>
            <td style="padding:8px;border-bottom:1px solid #ddd">EPOS only</td>
          </tr>
        </table>
        <p style="font-size:0.85rem;color:#d84315;margin-bottom:15px">
          <strong>If deployed on Cloudflare:</strong> Select <strong>HTTPS/ePOS (8043)</strong> for test print to work!<br>
          (TCP requires Node.js backend - use local server for TCP testing)
        </p>
        
        <p style="margin-bottom:10px"><strong>Why print doesn't work directly?</strong></p>
        <p style="font-size:0.9rem;color:#666;margin-bottom:15px">Browsers cannot directly connect to network printers (TCP/IP). Cloudflare Pages is a static hosting service - it only serves files, no backend code.</p>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:10px"><strong>OPTION A - Use Local Node.js Server (Recommended for testing)</strong></p>
        <ol style="font-size:0.85rem;color:#666;margin-left:20px;margin-bottom:15px">
          <li style="margin-bottom:5px">Install Node.js from <a href="https://nodejs.org" target="_blank">nodejs.org</a></li>
          <li style="margin-bottom:5px">Open terminal, navigate to project folder</li>
          <li style="margin-bottom:5px">Run: <code>npm install</code></li>
          <li style="margin-bottom:5px">Run: <code>node server.js</code></li>
          <li style="margin-bottom:5px">Open <code>http://localhost:3000</code> for customer page</li>
          <li style="margin-bottom:5px">Open <code>http://localhost:3000/admin.html</code> for admin</li>
          <li style="margin-bottom:5px">Keep terminal open - printing will work!</li>
        </ol>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:10px"><strong>OPTION B - Use Cloudflare Worker (For cloud deployment)</strong></p>
        <ol style="font-size:0.85rem;color:#666;margin-left:20px;margin-bottom:15px">
          <li style="margin-bottom:5px">See <strong>CLOUDFLARE_WORKER_SETUP.md</strong> in project for detailed steps</li>
          <li style="margin-bottom:5px">Create Cloudflare Worker from <strong>cloudflare-worker.js</strong> file</li>
          <li style="margin-bottom:5px">Configure printer to use <strong>HTTPS/ePOS (8043)</strong> mode only</li>
          <li style="margin-bottom:5px">Test print should work with EPOS-compatible printers</li>
        </ol>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:10px"><strong>OPTION C - Use PrintNode Service (For production)</strong></p>
        <ol style="font-size:0.85rem;color:#666;margin-left:20px;margin-bottom:15px">
          <li style="margin-bottom:5px">Go to <a href="https://printnode.com" target="_blank">printnode.com</a> and create account</li>
          <li style="margin-bottom:5px">Download and install PrintNode Client on a Windows PC connected to printer</li>
          <li style="margin-bottom:5px">Get your Account ID from PrintNode dashboard</li>
          <li style="margin-bottom:5px">Note the Printer ID from PrintNode</li>
          <li style="margin-bottom:5px">You would need to modify code to use PrintNode API - requires developer work</li>
        </ol>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:5px"><strong>QUICKEST START:</strong> Use Option A for testing. For production, consider Option B (Cloudflare Worker + EPOS printers) or hire developer to implement Option C.</p>
      </div>
    </section>
        </ol>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:10px"><strong>OPTION C - Use Cloudflare Workers (Advanced)</strong></p>
        <ol style="font-size:0.85rem;color:#666;margin-left:20px;margin-bottom:15px">
          <li style="margin-bottom:5px">Create a Cloudflare Worker</li>
          <li style="margin-bottom:5px">Write JavaScript code to handle print requests</li>
          <li style="margin-bottom:5px">Use fetch() to send ESC/POS commands to printer IP</li>
          <li style="margin-bottom:5px">Update frontend to call worker URL instead of local server</li>
          <li style="margin-bottom:5px">Note: Worker must be on paid plan for TCP connections</li>
        </ol>
        
        <p style="font-size:0.9rem;color:#666;margin-bottom:5px"><strong>QUICKEST START:</strong> Use Option A for testing. For production, consider Option B or hire developer to implement Option C.</p>
      </div>
    </section>

    <section>
      <h3>Printer Settings</h3>
      <div class="form-group">
        <label>Food Printer IP: <input id="foodIp" type="text" placeholder="192.168.x.x" /></label>
        <label>Port Type: 
          <select id="foodPortType" style="width:120px">
            <option value="tcp">TCP (9100)</option>
            <option value="https">HTTPS/ePOS (8043)</option>
          </select>
        </label>
        <label>Port: <input id="foodPort" type="number" value="9100" style="width:80px"/></label>
      </div>
      <div class="form-group">
        <label>Drink Printer IP: <input id="drinkIp" type="text" placeholder="192.168.x.x" /></label>
        <label>Port Type: 
          <select id="drinkPortType" style="width:120px">
            <option value="tcp">TCP (9100)</option>
            <option value="https">HTTPS/ePOS (8043)</option>
          </select>
        </label>
        <label>Port: <input id="drinkPort" type="number" value="9100" style="width:80px"/></label>
      </div>
      <button id="saveConfig">Save Printer Config</button>
      <span id="saveStatus" style="margin-left:8px;color:green"></span>
      <div style="margin-top:15px;padding-top:15px;border-top:1px solid #eee">
        <h4>Test Print (via Server)</h4>
        <div class="form-group">
          <label>Test Printer IP: <input id="testIp" type="text" placeholder="192.168.x.x" /></label>
          <label>Port Type: 
            <select id="testPortType" style="width:120px">
              <option value="tcp">TCP (9100)</option>
              <option value="https">HTTPS/ePOS (8043)</option>
            </select>
          </label>
          <label>Port: <input id="testPort" type="number" value="9100" style="width:80px"/></label>
        </div>
        <button id="testPrint" class="test-print-btn">Test Print (Server)</button>
        <span id="testStatus" style="margin-left:8px"></span>
      </div>
    </section>
      <div style="margin-top:15px;padding-top:15px;border-top:1px solid #eee">
        <h4>Test Print (via Epson ePOS SDK)</h4>
        <div class="form-group">
          <label>Printer IP: <input id="eposIp" type="text" placeholder="192.168.x.x" value="192.168.18.50" /></label>
        </div>
        <button id="testPrintEpos" style="background:#2196F3;">Test Print (ePOS SDK)</button>
        <span id="eposStatus" style="margin-left:8px"></span>
      </div>
    </section>
    <section>
      <h3>Data Management</h3>
      <button id="resetDefaults" style="background:#ff4444;">Reset to Defaults</button>
    </section>
    <section>
      <h3>Live Orders</h3>
      <ul id="ordersList"></ul>
    </section>
  </div>
  <script src="js/data.js"></script>
  <script src="js/admin.js"></script>
  <script src="epos-2.27.0.js"></script>
  <script>
    // Epson TM-m30 HTTP Print - uses printer's built-in web server
    async function testPrintEpos() {
      const ip = document.getElementById('eposIp').value;
      const status = document.getElementById('eposStatus');
      
      if (!ip) {
        status.textContent = 'Please enter printer IP';
        status.style.color = 'red';
        return;
      }
      
      status.textContent = 'Sending print via HTTP...';
      status.style.color = '#666';
      
      try {
        // TM-m30 can print via HTTP POST to its web interface
        // Build ESC/POS commands manually
        const ESC = '\x1B';
        const LF = '\x0A';
        
        let printData = '';
        printData += ESC + '@';  // Initialize
        printData += 'TEST PRINT' + LF;
        printData += '==========' + LF + LF;
        printData += 'Hello World!' + LF;
        printData += LF + LF + LF + LF;
        
        // Send via server proxy to avoid CORS
        const response = await fetch('/api/print/http', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ip: ip,
            data: printData
          })
        });
        
        if (response.ok) {
          status.textContent = 'Print sent! Check printer';
          status.style.color = 'green';
        } else {
          const err = await response.text();
          status.textContent = 'Error: ' + err;
          status.style.color = 'red';
        }
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.style.color = 'red';
        console.error('Print Error:', e);
      }
    }
    
    document.getElementById('testPrintEpos').addEventListener('click', testPrintEpos);
  </script>
</body>
</html>
