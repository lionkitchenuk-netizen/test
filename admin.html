<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin - POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#333;padding:20px}
    .admin{max-width:800px;margin:0 auto}
    h1{color:#667eea;margin-bottom:20px}
    section{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h3{color:#333;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #667eea}
    .form-group{margin-bottom:15px}
    label{display:block;margin-bottom:5px;color:#666}
    input,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:1rem}
    button{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:10px;margin-top:10px}
    #ordersList{list-style:none}
    #ordersList li{padding:15px;border-bottom:1px solid #eee}
    .test-print-btn{background:#4caf50!important}
    .empty{text-align:center;color:#999;padding:20px}
    .order-header{display:flex;justify-content:space-between;margin-bottom:10px}
    .order-time{color:#666;font-size:0.85rem}
    .order-items{margin:10px 0;padding:10px;background:#f8f8f8;border-radius:6px}
    .order-total{font-weight:bold;color:#667eea;margin:10px 0}
    .mark-paid-btn{background:#ff9800!important}
  </style>
</head>
<body>
  <div class="admin">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h1 style="margin:0">Admin</h1>
      <a href="setup.html" style="background:#2196F3;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:500">üìö Setup Instructions</a>
    </div>
    
    <section>
      <h3>üìã Pending Orders</h3>
      <div id="pendingOrders"></div>
    </section>
    
    <section>
      <h3>ü™ë Table Management</h3>
      <div id="tablesManagement"></div>
      <button id="addTable" style="background:#4caf50">+ Add Table</button>
    </section>
    
    <section>
      <h3>CSV Management</h3>
      <div style="background:#e8f5e9;padding:12px;border-radius:6px;margin-bottom:15px;font-size:0.9rem">
        <strong>üìå Important:</strong> After uploading a CSV file, click <strong>Upload</strong>, then refresh the Order page to load the new data.
      </div>
      <select id="csvSelect" style="margin-bottom:10px">
        <option value="menu.csv">üìã menu.csv (Food & Drink Items)</option>
        <option value="tables.csv">ü™ë tables.csv (Table Configuration)</option>
        <option value="sets.csv">sets.csv</option>
        <option value="attributes.csv">attributes.csv</option>
      </select>
      <input type="file" id="csvFile" accept=".csv" style="margin-bottom:10px" />
      <div>
        <button id="validateCsv">‚úì Validate</button>
        <button id="uploadCsv" style="background:#4caf50">‚¨ÜÔ∏è Upload CSV</button>
        <button id="downloadCsv">‚¨áÔ∏è Download Template</button>
      </div>
      <div style="background:#fff3e0;padding:10px;border-radius:6px;margin-top:10px;font-size:0.9rem">
        <strong>Data Status:</strong>
        <pre id="dataStatus" style="margin:10px 0 0 0;font-size:0.85rem"></pre>
      </div>
      <pre id="csvPreview" style="max-height:200px;overflow:auto;border:1px solid #eee;padding:8px;margin-top:10px"></pre>
    </section>
    <section>
      <h3>üñ®Ô∏è Printer Configuration</h3>
      <div style="background:#e3f2fd;padding:12px;border-radius:6px;margin-bottom:15px;font-size:0.9rem">
        <strong>‚ÑπÔ∏è Using Epson ePOS SDK (Port 8043)</strong><br>
        Make sure your printers have <strong>ePOS enabled</strong>. Need help? Check <a href="setup.html" style="color:#1976d2;text-decoration:underline">Setup Instructions</a>.
      </div>

      <div class="form-group">
        <label><strong>Food Printer IP Address</strong></label>
        <input id="foodIp" type="text" placeholder="e.g., 192.168.1.100" />
        <small style="color:#666;font-size:0.85rem">Enter the IP address of your food/kitchen printer</small>
      </div>
      <div class="form-group">
        <label><strong>Drink Printer IP Address</strong></label>
        <input id="drinkIp" type="text" placeholder="e.g., 192.168.1.101" />
        <small style="color:#666;font-size:0.85rem">Enter the IP address of your drink/bar printer (can be same as food printer)</small>
      </div>
      <button id="saveConfig">üíæ Save Configuration</button>
      <span id="saveStatus" style="margin-left:8px;color:green"></span>
      
      <div style="margin-top:20px;padding-top:20px;border-top:1px solid #eee">
        <h4 style="margin-bottom:10px">üß™ Test Print</h4>
        <div class="form-group">
          <label><strong>Test Printer IP</strong></label>
          <input id="eposIp" type="text" placeholder="e.g., 192.168.1.100" />
          <small style="color:#666;font-size:0.85rem">Enter any printer IP to test connection</small>
        </div>
        <button id="testPrintEpos" style="background:#4caf50;">‚úì Send Test Print</button>
        <span id="eposStatus" style="margin-left:8px"></span>
      </div>
    </section>
    <section>
      <h3>Data Management</h3>
      <button id="resetDefaults" style="background:#ff4444;">Reset to Defaults</button>
    </section>
  </div>
  <script src="js/data.js"></script>
  <script src="js/admin.js"></script>
  <script src="epos-2.27.0.js"></script>
  <script>
    // Load saved ePOS IP on page load
    window.addEventListener('DOMContentLoaded', function() {
      const config = JSON.parse(localStorage.getItem('printerConfig') || '{}');
      const savedIp = config.eposTestIp || '192.168.1.165';
      document.getElementById('eposIp').value = savedIp;
    });
    
    // Save ePOS IP when changed
    document.getElementById('eposIp').addEventListener('blur', function() {
      const config = JSON.parse(localStorage.getItem('printerConfig') || '{}');
      config.eposTestIp = this.value;
      localStorage.setItem('printerConfig', JSON.stringify(config));
    });
    
    // Direct browser-to-printer using Epson ePOS SDK
    function testPrintEpos() {
      const ip = document.getElementById('eposIp').value;
      const status = document.getElementById('eposStatus');
      
      // Save IP
      const config = JSON.parse(localStorage.getItem('printerConfig') || '{}');
      config.eposTestIp = ip;
      localStorage.setItem('printerConfig', JSON.stringify(config));
      
      if (!ip) {
        status.textContent = 'Please enter printer IP';
        status.style.color = 'red';
        return;
      }
      
      status.textContent = 'Connecting to ' + ip + ':8043...';
      status.style.color = '#666';
      
      try {
        // Create ePOS Device object
        var eposDevice = new epson.ePOSDevice();
        
        // Connect to printer (port 8043 is ePOS SDK HTTPS)
        eposDevice.connect(ip, 8043, function(data) {
          if (data === 'OK' || data === 'SSL_CONNECT_OK') {
            status.textContent = 'Connected! Creating print job...';
            
            // Create printer object
            eposDevice.createDevice('local_printer', eposDevice.DEVICE_TYPE_PRINTER, {
              crypto: false,
              buffer: false
            }, function(devobj, retcode) {
              if (retcode === 'OK') {
                var printer = devobj;
                
                // Build print document
                printer.addTextAlign(printer.ALIGN_CENTER);
                printer.addText('TEST PRINT\n');
                printer.addText('=========================\n');
                printer.addTextAlign(printer.ALIGN_LEFT);
                printer.addText('Hello World!\n');
                printer.addText('Epson ePOS SDK Print\n');
                printer.addFeedLine(3);
                printer.addCut(printer.CUT_FEED);
                
                // Send to printer
                printer.send();
                
                // Handle response
                printer.onreceive = function(res) {
                  if (res.success) {
                    status.textContent = 'Print sent successfully!';
                    status.style.color = 'green';
                  } else {
                    status.textContent = 'Print error: ' + res.code;
                    status.style.color = 'red';
                  }
                  eposDevice.deleteDevice(printer);
                  eposDevice.disconnect();
                };
                
                printer.onerror = function(err) {
                  status.textContent = 'Printer error: ' + err.status;
                  status.style.color = 'red';
                  eposDevice.deleteDevice(printer);
                  eposDevice.disconnect();
                };
              } else {
                status.textContent = 'Failed to create printer object: ' + retcode;
                status.style.color = 'red';
                eposDevice.disconnect();
              }
            });
          } else {
            status.textContent = 'Connection failed: ' + data;
            status.style.color = 'red';
            
            // Show helpful error message
            if (data.includes('TIMEOUT')) {
              setTimeout(function() {
                status.textContent = 'Timeout - Check: 1) Printer is on, 2) ePOS SDK enabled on port 8043, 3) Same network';
              }, 1000);
            }
          }
        });
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.style.color = 'red';
        console.error('Print Error:', e);
      }
    }
    
    document.getElementById('testPrintEpos').addEventListener('click', testPrintEpos);
  </script>
</body>
</html>
